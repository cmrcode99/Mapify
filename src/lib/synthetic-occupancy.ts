/**
 * Synthetic occupancy generator.
 * Produces deterministic, time-aware fake checkin data for every campus building
 * so the map looks alive. Real Supabase checkins override these.
 */

import type { ActiveCheckinData } from "./types";

/* ── Seeded PRNG ── */
function seedFromString(s: string): number {
    let h = 0;
    for (let i = 0; i < s.length; i++) h = (Math.imul(31, h) + s.charCodeAt(i)) | 0;
    return h >>> 0;
}

function mulberry32(seed: number) {
    let t = seed;
    return () => {
        t = (t + 0x6d2b79f5) | 0;
        let r = Math.imul(t ^ (t >>> 15), t | 1);
        r ^= r + Math.imul(r ^ (r >>> 7), r | 61);
        return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
    };
}

/* ── Time-of-day campus busyness curve (0–23h, values 0–1) ── */
const HOUR_CURVE = [
    0.02, 0.01, 0.01, 0.01, 0.02, 0.04, // 0-5
    0.08, 0.18, 0.35, 0.55, 0.70, 0.65,  // 6-11
    0.50, 0.60, 0.72, 0.65, 0.50, 0.38,  // 12-17
    0.25, 0.18, 0.12, 0.08, 0.05, 0.03,  // 18-23
];

/* ── Day-of-week multiplier (0=Sun … 6=Sat) ── */
const DAY_MULT = [0.15, 0.85, 0.90, 0.95, 0.90, 0.70, 0.20];

/* ── Building popularity tiers ── */
const POPULARITY: Record<string, number> = {
    SC: 1.3, GELIB: 1.2, ECEB: 1.2, DCL: 1.1, UGL: 1.15, LIB: 1.2, IU: 1.1,
    BIF: 1.05, CIF: 1.1, CSL: 0.9, BECK: 0.85, EH: 0.95, LOOM: 0.9,
    RAL: 0.85, NOYES: 0.85, LH: 0.95, FOEL: 0.8, ALT: 0.85, DKH: 0.9,
    WOH: 0.8, EDU: 0.8, NHB: 0.6, MORR: 0.5, TB: 0.55, PSYCH: 0.6,
    FLB: 0.5, HARK: 0.4, TBH: 0.4, ADB: 0.4, MUS: 0.45, ARM: 0.5,
    SCD: 0.75, MNTL: 0.7, NCSA: 0.6, IGB: 0.55, ARC: 0.7, CRCE: 0.65,
};

/* ── Realistic room numbers per building (20–30 rooms each) ── */
const BUILDING_ROOMS: Record<string, string[]> = {
    SC: [
        "1404", "1302", "1214", "1109", "1103", "1106", "1112",
        "0216", "0218", "0220", "0222",
        "2102", "2105", "2124", "2260", "2405", "2407",
        "3102", "3124", "3401", "3403",
        "4102", "4124", "4203", "4207", "4305",
    ],
    SCD: [
        "1010", "1020", "1030", "1040", "1050", "1060",
        "2010", "2020", "2030", "2040", "2050", "2060", "2070", "2080",
        "3010", "3020", "3030", "3040", "3050",
        "4010", "4020", "4030",
    ],
    GELIB: [
        "100", "101", "102", "103", "104", "105", "106", "126",
        "200", "210", "214", "218", "220", "222", "230",
        "300", "306", "308", "310", "314", "318",
        "4N", "4S", "4E", "4W",
    ],
    ECEB: [
        "1002", "1013", "1014", "1016", "1022", "1024", "1031",
        "2015", "2070", "2076",
        "3005", "3008", "3013", "3015", "3017", "3070",
        "4020", "4026", "4070",
        "5020", "5070", "5078",
    ],
    DCL: [
        "1109", "1115", "1172", "1230", "1240", "1264", "1285", "1310", "1320",
        "2202", "2214", "2228", "2240", "2260", "2270",
        "L220", "L416", "L440", "L450", "L520",
    ],
    CSL: [
        "101", "110", "141", "210", "211", "240", "260",
        "301", "304", "310", "340", "360",
        "401", "405", "410", "440",
        "B02", "B10", "B15", "B21", "B28",
    ],
    BECK: [
        "1005", "1012", "1014", "1018", "1040",
        "2100", "2124", "2164", "2200", "2269", "2274",
        "3100", "3124", "3164", "3200", "3264",
        "4100", "4124", "4200", "4264", "4401",
    ],
    EH: [
        "106A", "106B", "106C", "128", "136", "148",
        "206B", "206S6", "212", "228", "236",
        "306", "312", "328", "336",
        "406A", "406B", "412", "428",
        "B10", "B14", "B20",
    ],
    TB: [
        "104", "108", "116", "120", "126", "132",
        "204", "210", "214", "220", "226", "230",
        "304", "308", "312", "318",
        "B06", "B10", "B14", "B20",
    ],
    EVER: [
        "1100", "1103", "1106", "1110", "1215", "1232", "1270",
        "2105", "2110", "2130", "2150", "2233", "2260",
        "3100", "3106", "3130", "3160", "3200", "3240",
        "4100", "4140",
    ],
    TALB: [
        "100", "102", "104", "108", "112",
        "200", "204", "208", "212", "216",
        "300", "304", "308", "312", "316",
        "B04", "B08", "B12", "B16",
        "G100", "G104",
    ],
    MEL: [
        "100", "102", "110", "115", "120", "130",
        "200", "206", "214", "220", "230", "258",
        "300", "310", "320", "330", "340", "350", "362",
        "B10", "B20",
    ],
    MSEB: [
        "100", "106", "110", "112", "120",
        "200", "204", "211", "216", "220",
        "300", "304", "310", "316", "320",
        "B06", "B10", "B14", "B20",
        "G14", "G20",
    ],
    NCEL: [
        "1001", "1015", "1020", "1030", "1040",
        "2105", "2110", "2120", "2210", "2216", "2220",
        "3105", "3110", "3120", "3216", "3220",
        "B101", "B105", "B110", "B120",
    ],
    HYDRO: [
        "100", "103", "106", "110", "115",
        "200", "203", "206", "210", "215",
        "300", "303", "306", "310",
        "B01", "B04", "B08", "B12",
        "G01", "G04",
    ],
    LOOM: [
        "100", "104", "116", "118", "128", "141", "158",
        "201", "206", "211", "228", "236", "244",
        "301", "306", "314", "328",
        "B105", "B110", "B115",
        "G100", "G104", "G108",
    ],
    NCSA: [
        "1010", "1020", "1040", "1060", "1080",
        "2010", "2040", "2060", "2080", "2100",
        "3020", "3040", "3060", "3080", "3100",
        "4010", "4030", "4050", "4070",
        "B10", "B20",
    ],
    MNTL: [
        "1005", "1010", "1020", "1040", "1060",
        "2020", "2040", "2060", "2080", "2110", "2220",
        "3020", "3040", "3060", "3080",
        "4020", "4040", "4060", "4070", "4080",
        "B10", "B20", "B40",
    ],
    NPL: [
        "110", "115", "120", "125", "130",
        "210", "215", "220", "225",
        "310", "315", "320",
        "B01", "B05", "B10",
        "G10", "G14", "G18", "G22",
    ],
    LUMEB: [
        "1100", "1120", "1150", "1200", "1250",
        "2100", "2120", "2150", "2200", "2250", "2315",
        "3010", "3020", "3045", "3060", "3080",
        "B100", "B120", "B140",
        "G10", "G20", "G30",
    ],
    NOYES: [
        "100", "102", "104", "116", "120", "130", "160",
        "200", "206", "210", "216", "217", "224",
        "300", "306", "310", "316", "320",
        "B06", "B10", "B14", "B18",
    ],
    RAL: [
        "100", "108", "116", "120", "122", "126",
        "200", "206", "210", "214", "217",
        "300", "306", "310", "316", "320", "335",
        "B08", "B10", "B20", "B24",
        "G10", "G14",
    ],
    CLSL: [
        "B100", "B103", "B112", "B120", "B130", "B140", "B150",
        "B200", "B210", "B220", "B230", "B235",
        "100", "110", "120", "130",
        "200", "210", "220", "230",
        "300", "310", "320", "322",
    ],
    NHB: [
        "101", "102", "106", "110", "120", "130",
        "200", "204", "210", "214", "220",
        "300", "306", "310", "312", "316",
        "B06", "B10", "B14", "B18",
        "G10", "G14",
    ],
    MORR: [
        "100", "106", "112", "118", "124", "131",
        "200", "206", "212", "218", "224",
        "300", "306", "312", "318", "324", "327",
        "B06", "B10", "B14",
    ],
    BURR: [
        "100", "106", "112", "118", "122",
        "200", "206", "212", "214", "218",
        "300", "306", "312",
        "B06", "B10", "B14",
        "G10", "G14", "G18", "G22",
    ],
    PSYCH: [
        "100", "106", "110", "115", "120",
        "200", "206", "210", "215", "220",
        "300", "306", "310", "315", "321",
        "B06", "B10", "B14", "B18",
        "G10", "G14",
    ],
    TURN: [
        "101", "106", "110", "116", "120",
        "200", "206", "210", "216", "220",
        "300", "306", "310", "316",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
    ],
    MADI: [
        "100", "104", "108", "112", "116",
        "200", "204", "210", "214", "220",
        "300", "304", "310", "314",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
    ],
    LH: [
        "106", "112", "118", "122", "128", "136",
        "200", "202", "206", "210", "214", "218",
        "300", "304", "308", "312", "316",
        "B06", "B10", "B14", "B18",
        "G10", "G14",
    ],
    FOEL: [
        "100",
        "201", "202", "204", "206", "208", "210",
        "212", "214", "216", "218", "220",
        "B01", "B02", "B04", "B06", "B08",
        "G01", "G02", "G04",
    ],
    ALT: [
        "100", "114", "120", "131", "141",
        "200", "206", "216", "228", "243",
        "300", "306", "314", "328", "345",
        "B01", "B05", "B10",
        "G10", "G14", "G18", "G22",
    ],
    GREG: [
        "100", "106", "110", "116", "120",
        "200", "205", "210", "216", "220",
        "300", "306", "310", "312", "316",
        "B06", "B10", "B14",
        "G10", "G14", "G18", "G22",
    ],
    EB: [
        "100", "103", "106", "110", "116", "120",
        "200", "206", "209", "210", "216", "220",
        "300", "306", "310", "313", "316",
        "B06", "B10", "B14",
        "G10", "G14",
    ],
    FLB: [
        "G11", "G15", "G19", "G23", "G27",
        "100", "106", "111", "116", "120",
        "200", "206", "210", "213", "216",
        "300", "306", "310", "314",
        "B06", "B10", "B14",
    ],
    DAV: [
        "100", "106", "110", "116", "120",
        "200", "206", "210", "216", "220",
        "300", "301", "306", "310", "316",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
    ],
    SMH: [
        "100", "102", "106", "110", "114",
        "200", "204", "206", "210", "214",
        "300", "304", "308", "312",
        "B06", "B10", "B14",
        "G10", "G14", "G18", "G22",
    ],
    DKH: [
        "100", "104", "107", "110", "114", "118",
        "200", "204", "209", "214", "218",
        "300", "304", "308", "313", "318",
        "400", "404", "406", "410",
        "B06", "B10", "B14",
    ],
    HAB: [
        "100", "106", "110", "115", "120",
        "200", "206", "210", "215", "220",
        "300", "306", "310", "315",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
    ],
    HARK: [
        "100", "105", "110", "115", "120",
        "200", "205", "206", "210", "215",
        "300", "305", "310",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
    ],
    IH: [
        "100", "106", "110", "117", "120",
        "200", "201", "206", "210", "216",
        "300", "306", "311", "316",
        "B06", "B10", "B14",
        "G10", "G14", "G18", "G22",
    ],
    COB: [
        "100", "104", "108", "112", "116",
        "200", "204", "210", "214",
        "300", "304", "308", "312",
        "B06", "B10", "B14",
        "G10", "G14", "G18", "G22",
    ],
    BIF: [
        "1010", "1012", "1016", "1020", "1022", "1024",
        "1030", "1034", "1040",
        "2010", "2020", "2040", "2060", "2062", "2064",
        "3010", "3020", "3040", "3060",
        "4010", "4020", "4030",
    ],
    WOH: [
        "100", "105", "110", "115", "120", "124",
        "200", "206", "210", "216", "220", "230", "238",
        "300", "306", "310", "316",
        "B06", "B10", "B14",
        "G10", "G14",
    ],
    LIB: [
        "100", "110", "120", "130", "145",
        "200", "210", "220", "230",
        "300", "306", "310", "320",
        "400", "401", "410", "420",
        "500", "506", "510",
        "600", "610", "620",
    ],
    UGL: [
        "100", "101", "103", "104", "106", "110", "114",
        "200", "201", "204", "205", "206", "210", "214",
        "300", "304", "308", "312",
        "B06", "B10", "B14", "B18",
    ],
    IU: [
        "100", "106", "110", "115", "120",
        "200", "206", "210", "214", "220",
        "300", "306", "310", "314",
        "400", "405", "410",
        "B06", "B10", "B14",
        "G10", "G14",
    ],
    KCPA: [
        "100", "112", "116", "120",
        "200", "207", "210", "215",
        "300", "306",
        "SB", "Stage1", "Stage2",
        "B01", "B06", "B10",
        "G10", "G14", "G18",
    ],
    SPUR: [
        "100", "102", "104", "106", "110",
        "200", "204", "208", "212",
        "B01", "B04", "B08",
        "G10", "G14", "G18",
        "300", "304", "308", "312",
    ],
    SWAN: [
        "100", "106", "110", "115", "120",
        "200", "206", "210", "215", "220",
        "300", "305", "310", "315",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
    ],
    MUM: [
        "100", "101", "106", "110", "116",
        "200", "204", "210", "216", "220",
        "300", "303", "306", "310",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
    ],
    BEV: [
        "100", "106", "110", "114", "120",
        "200", "206", "210", "215", "220",
        "300", "306", "310", "316",
        "B06", "B10", "B14",
        "G10", "G14",
    ],
    ACES: [
        "100", "106", "110", "115", "120", "125", "131",
        "200", "206", "210", "215", "220",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
        "300", "306", "310",
    ],
    ASL: [
        "100", "103", "108", "112", "116",
        "200", "206", "210", "214", "220",
        "300", "306", "310", "316",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
    ],
    PSL: [
        "100", "104", "108", "112",
        "200", "204", "210", "214",
        "300", "304", "308",
        "B06", "B10", "B14",
        "G10", "G14", "G18", "G22",
    ],
    AESB: [
        "100", "106", "110", "114", "120",
        "200", "206", "210", "213", "216", "220",
        "300", "306", "310", "314",
        "B06", "B10", "B14",
        "G10", "G14",
    ],
    EDU: [
        "22", "23", "24", "100", "110",
        "200", "204", "210", "212", "216",
        "300", "306", "310", "316",
        "B06", "B10", "B14",
        "G10", "G14", "G18", "G22",
    ],
    CDL: [
        "100", "102", "106", "110", "114",
        "200", "204", "208", "212", "216",
        "300", "304", "308",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
    ],
    SSW: [
        "100", "106", "110", "115", "121",
        "200", "206", "209", "210", "216",
        "300", "306", "310",
        "B06", "B10", "B14",
        "G10", "G14", "G18", "G22",
    ],
    ARM: [
        "101", "110", "120", "130", "140",
        "200", "206", "210", "216",
        "301", "306", "310",
        "W100", "W110", "W200", "W202",
        "B06", "B10", "B14", "B18",
    ],
    HUFF: [
        "100", "106", "109", "112", "116",
        "200", "206", "210", "214", "220",
        "300", "304", "308", "312",
        "B06", "B10", "B14",
        "G10", "G14", "G18",
    ],
    CRCE: [
        "GYM1", "GYM2", "GYM3",
        "100", "102", "106", "110",
        "200", "204", "208",
        "POOL", "TRACK",
        "B06", "B10", "B14",
        "G10", "G14", "G18", "G22",
    ],
    ARC: [
        "MAIN", "POOL", "TRACK",
        "GYM1", "GYM2", "GYM3", "GYM4",
        "100", "106", "110", "116",
        "200", "206", "210", "216",
        "300", "306", "310",
        "B06", "B10", "B14",
    ],
    TBH: [
        "100", "101", "106", "110", "116",
        "200", "205", "210", "216", "220",
        "300", "306", "310", "312", "316",
        "B06", "B10", "B14",
        "G10", "G14",
    ],
    ADB: [
        "100", "106", "110", "116", "120",
        "200", "206", "210", "216", "220",
        "300", "306", "310", "312", "316",
        "B06", "B10", "B14",
        "G10", "G14",
    ],
    MUS: [
        "100", "106", "110", "115", "120",
        "200", "206", "210", "215", "220",
        "300", "303", "306", "310",
        "B06", "B10", "B14",
        "G143", "G237",
    ],
    LAW: [
        "100", "110", "120", "125", "130", "140",
        "200", "210", "220", "230", "240",
        "300", "310", "320",
        "L100", "L110", "L120", "L125",
        "B06", "B10",
    ],
    CIF: [
        "1010", "1015", "1020", "1025", "1030",
        "2010", "2015", "2020", "2025", "2030",
        "3010", "3015", "3020",
        "B010", "B020", "B030",
        "G10", "G20", "G30", "G40",
    ],
    NCSA2: [
        "1010", "1020", "1040", "1060", "1080",
        "2010", "2040", "2060", "2080", "2100",
        "3020", "3040", "3060", "3080", "3100",
        "4010", "4030", "4050", "4070",
        "B10", "B20",
    ],
    IGB: [
        "100", "110", "120", "130",
        "200", "210", "220", "230",
        "400", "410", "420",
        "500", "510", "520",
        "600", "612", "620",
        "1030", "1040", "2034",
    ],
};

// Buildings that are NOT real academic/study buildings (arenas, dorms, etc.)
const NON_BUILDINGS = new Set([
    "SFC", "MEM",
    "IKEN", "PAR", "ISR", "LAR", "FAR", "NUG", "WAS",
    "ECEBA",
]);

/**
 * Generate synthetic ActiveCheckinData for every building.
 * Uses current time to produce realistic occupancy that varies throughout the day.
 */
export function generateSyntheticCheckins(
    buildings: { id: string; code: string; name: string; latitude: number; longitude: number; address: string | null }[]
): ActiveCheckinData[] {
    const now = new Date();
    const hour = now.getHours();
    const dow = now.getDay();
    const minute = now.getMinutes();

    const hourFrac = minute / 60;
    const curveNow = HOUR_CURVE[hour];
    const curveNext = HOUR_CURVE[(hour + 1) % 24];
    const baseActivity = curveNow + (curveNext - curveNow) * hourFrac;
    const dayMult = DAY_MULT[dow];

    const results: ActiveCheckinData[] = [];

    for (const b of buildings) {
        // Skip non-buildings
        if (NON_BUILDINGS.has(b.code)) continue;

        const rooms = BUILDING_ROOMS[b.code];
        if (!rooms) continue;

        const rand = mulberry32(seedFromString(b.code + now.toDateString()));
        const popularity = POPULARITY[b.code] ?? (0.4 + rand() * 0.5);

        const maxPeople = rooms.length * 6;
        const rawCount = Math.round(baseActivity * dayMult * popularity * maxPeople);
        const jitter = Math.round((rand() - 0.5) * rawCount * 0.3);
        const totalCount = Math.max(0, rawCount + jitter);

        if (totalCount === 0) {
            results.push({
                building_id: b.id,
                building_name: b.name,
                building_code: b.code,
                latitude: b.latitude,
                longitude: b.longitude,
                active_count: 0,
                rooms: [],
                address: b.address,
            });
            continue;
        }

        // Distribute people across rooms
        const roomEntries: { room: string; count: number }[] = [];
        let remaining = totalCount;

        for (let i = 0; i < rooms.length; i++) {
            if (remaining <= 0) break;
            const isLast = i === rooms.length - 1;
            const share = isLast
                ? remaining
                : Math.max(0, Math.round(remaining * (0.05 + rand() * 0.15)));

            if (share > 0) {
                roomEntries.push({ room: rooms[i], count: share });
                remaining -= share;
            }
        }

        if (remaining > 0 && roomEntries.length > 0) {
            roomEntries[0].count += remaining;
        }

        results.push({
            building_id: b.id,
            building_name: b.name,
            building_code: b.code,
            latitude: b.latitude,
            longitude: b.longitude,
            active_count: totalCount,
            rooms: roomEntries,
            address: b.address,
        });
    }

    return results;
}

/**
 * Merge real Supabase checkin data with synthetic data.
 * Real data takes priority — for each building we use whichever has more people.
 */
export function mergeWithSynthetic(
    realData: ActiveCheckinData[],
    syntheticData: ActiveCheckinData[]
): ActiveCheckinData[] {
    const realMap = new Map(realData.map((d) => [d.building_id, d]));
    const result: ActiveCheckinData[] = [];

    for (const synth of syntheticData) {
        const real = realMap.get(synth.building_id);

        if (!real || real.active_count === 0) {
            result.push(synth);
        } else if (real.active_count >= synth.active_count) {
            result.push(real);
        } else {
            // Keep real rooms, fill gap with synthetic rooms
            const realRoomSet = new Set(real.rooms.map((r) => r.room));
            const extraRooms = synth.rooms.filter((r) => !realRoomSet.has(r.room));
            const extraCount = synth.active_count - real.active_count;
            const extraTotal = extraRooms.reduce((s, r) => s + r.count, 0);
            const scaledExtras = extraTotal > 0
                ? extraRooms.map((r) => ({
                    room: r.room,
                    count: Math.max(1, Math.round((r.count / extraTotal) * extraCount)),
                }))
                : [];

            result.push({
                ...real,
                active_count: synth.active_count,
                rooms: [...real.rooms, ...scaledExtras],
            });
        }

        realMap.delete(synth.building_id);
    }

    // Any real buildings not in synthetic set
    for (const remaining of realMap.values()) {
        result.push(remaining);
    }

    return result;
}
